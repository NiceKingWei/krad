<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <script type="text/javascript" src="assets/js/phaser.min.js"></script>
  <script type="text/javascript" src="assets/js/CanvasInput.min.js"></script>
  <link href="assets/css/global.css" rel="stylesheet" type="text/css" />
  <script type="text/javascript" src="assets/js/jquery.min.js"></script>
  <link href='https://fonts.googleapis.com/css?family=Indie+Flower' rel='stylesheet' type='text/css'>
</head>
<body>
  <input type="text" id="nickname" class="inputbox1" style="left:410px;top:250px">
  <input type="radio" id="gender1" name="gender" style="left:410px;top:320px" value="0" checked="checked">
  <input type="radio" id="gender2" name="gender" style="left:510px;top:320px" value="1">
  <select class="select" id="a_avatar" style="left: 410px;top:365px" onchange="update_avatar()">
    <option value="figure1">figure1</option>
    <option value="figure2">figure2</option>
    <option value="figure3">figure3</option>
    <option value="figure4">figure4</option>
    

   <script>
  var game = new Phaser.Game(800, 600, Phaser.CANVAS, '', {
      preload: function () {
        game.load.image('background', 'assets/img/background1.png');
        game.load.image('input', 'assets/img/inputbox1.png', 20, 20);
        game.load.spritesheet('button','assets/buttons/button1.png',100,34);
        game.load.bitmapFont('chiller', 'assets/fonts/chiller.png', 'assets/fonts/chiller.xml');
        game.load.image('figure1','assets/img/figure/figure1.png');
        game.load.image('figure2','assets/img/figure/figure2.png');
        game.load.image('figure3','assets/img/figure/figure3.png');
        game.load.image('figure4','assets/img/figure/figure4.png');
      },
   
      create: function () {
        var background = game.add.sprite(0, 0, 'background');
        background.smoothed = true;
        background.height = game.height;
        background.width = game.width;

        var changeText = game.add.bitmapText(280, 130, 'chiller', 'Change Profile', 70);
        var nicknameText = game.add.bitmapText(260, 230, 'chiller', 'Nickname', 54);
        var genderText = game.add.bitmapText(280, 290, 'chiller', 'Gender', 54);
        var maleText = game.add.bitmapText(435, 290, 'chiller', 'Boy', 54);
        var femaleText = game.add.bitmapText(530, 290, 'chiller', 'Girl', 54);
        var avatarText = game.add.bitmapText(290, 345, 'chiller', 'Avatar', 54);

        var confirmButton = game.add.button(395, 400, 'button', do_change, this, 1, 0, 2);
        var confirmButtonText = game.add.bitmapText(415, 400, 'chiller', 'Confirm', 28);
        

        game.avatar = game.add.sprite(620,280,'figure1');
      }
    });

    function update_avatar(){
      game.avatar.kill();
      console.log($("#avatar").val());
      game.avatar = game.add.sprite(620,280,$("#a_avatar").val());
    }
    
    function do_change() {
      var nickname = $("#nickname").val();
      var avatar = "assets/img/figure/" + $("#avatar").val();
      var gender = $("input[name='gender']:checked").val();
      var req = {
        'nickname': nickname,
        'avatar': avatar,
        'gender': gender,
      };

      console.log(req);
      var v_nickname = /{};:'/.test(nickname);

      // todo: 判断图像地址
      if (v_nickname) {
        alert("昵称含有非法字符");
        return;
      }

      $.ajax({
        url: "/api/user/changeprofile",
        type: "POST",
        contentType: 'application/json',
        data: JSON.stringify(req),
        success: function (data, status) {
          alert("修改成功");
          console.log(data);
          //window.location.href = ''; 跳转用户界面
        },
        error: function (data, status) {
          alert("修改失败");
          console.log(data);
        }
      });
}

   </script>

</body>

</html>